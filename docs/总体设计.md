# 书店管理系统

SJTU ACM2025 许艺妃

## 程序功能概述

本书店管理系统是基于C++开发的命令行交互程序，面向店长、员工和顾客三类角色，提供账户管理、图书管理、日志管理三大核心功能。
系统通过权限分级管控不同角色的操作范围，支持嵌套登录的登录栈机制，所有核心数据均持久化储存到文件。
程序首次运行自动初始化超级管理员账户，支持指令行交互直至输入`quit/exit`退出，非法指令或操作失败统一输出`invalid\n`。

计划实现GUI前端。

## 主体逻辑说明

### 1.程序启动

检查数据目录是否存在，若不存在则创建并进行初始化；检查帐户数据文件是否存在，若不存在则创建 root 帐户（权限 7、密码 sjtu）；初始化登录栈、当前选中图书、权限状态等运行时变量。

### 2.指令处理

循环读取命令行输入指令，按以下流程处理：

1. 词法分析：去除行首行尾空格，合并连续空格，拆分指令为关键词 + 参数列表；
2. 合法性校验：校验指令格式、参数字符集 / 长度、权限等级是否满足，不满足则输出`Invalid\n`；
3. 指令执行：根据指令关键词分发至对应模块（帐户 / 图书 / 日志）执行核心逻辑，处理文件读写、数据更新；
4. 结果输出：按要求输出执行结果，成功则输出对应内容，失败输出`Invalid\n`，空指令无输出,遇`quit / exit`则正常退出，并flush文件。

### 3.程序退出

清空登录栈、释放运行时资源，确保所有数据已写入文件，正常退出。

## 代码文件结构

- `main.cpp`: 项目的入口文件，包含 main 函数，负责初始化系统核心模块、读取用户输入，并将指令交由指令解析器`CmdParser`处理，再分派到不同的业务模块执行。
- `CmdParser.h/.cpp`: 负责将用户输入的字符串分解、规范化与合法性校验，并将其映射为内部统一的`Command`对象，提供给`main()`调用。
- `AccountManager.h/.cpp`: 负责管理与用户账号权限相关的所有业务，内部维护一个权限栈`AccountSession`。
- `BookManager.h/.cpp`: 负责所有图书相关的业务，内部维护当前选中的书籍状态`SelectedBook`，并依赖`Persistence`层做数据读写。
- `Transaction.h/.cpp`: 负责交易记录与收支输出功能。
- `Logger.h/.cpp`: 负责系统日志的记录与查询。
- `Persistence.h/.cpp`: 负责底层数据的持久化，对上层提供统一接口。
- `Utils.h/.cpp`: 负责项目中用到的通用工具函数，包括校验函数、价格格式化、字符串处理、文件路径管理工具。
- `Types.hpp`: 定义全局通用的数据结构和类型。

## 功能设计

### 1.Bookstore主程序`main`

功能：
- 程序入口，包含`main()`
- 初始化所有核心模块`Parser`、`AccountManager`、`BookManager`、`Transaction`…
- 循环读取用户输入,调用`CmdParser`对输入进行解析
- 根据解析结果分派到对应模块执行
- 负责退出、错误输出等顶层逻辑

### 2.命令解析模块`CmdParser`

功能：
- 将用户输入拆分为`tokens`
- 校验指令格式、参数数量 
- 将其封装为`ParsedCommand`
- 处理非法命令与格式错误

### 3.账户管理模块`AccountManager`

功能：
- `register`
- `login`
- `logout`
- `su`
- `password`
- `useradd`
- `delete`

内部维护：
- 用户登录栈
- 当前用户权限等级
- 访问用户文件（依赖`Persistence`模块)

### 4.图书管理模块`BookManager`

功能：
- `show`
- `select`
- `modify` 
- `import` 
- `buy`

内部维护：
- 当前选中书籍`SelectedBook`
- 与各类索引交互（ISBN、书名、作者、关键字） 
- 调用`Persistence`层获取真实数据

### 5.交易模块`Transaction`

功能：
- 记录`import`和`buy`的金额变化
- `show_finance`
- 提供财务日志写入接口

### 6.日志管理模块`Logger`

记录内容包括：
- 登录、登出事件
- 用户增删、权限提升
- 图书修改
- 图书交易
- 系统异常（如非法操作）


### 7.文件模块`Persistence`

功能：
- 统一管理文件读写
- 提供查询、写入、更新、索引管理接口


### 8.工具模块`Utils`

提供工具：
- 数字与字符串格式化，价格保留两位小数
- 字符串合法性校验（ISBN、关键字等）
- 拆分关键字 
- 去引号、trim 
- 异常处理

## 数据库设计

所有数据文件均以二进制文件存储，随机读取操作加速查找。

| 文件名 | 功能 | 储存数据                   |
|-----|-----|------------------------|
| users.dat | 用户信息 | 用户权限、账号、密码             |
| books.dat | 图书信息 | ISBN、书名、作者、关键词串、库存量、单价 |
| index_isbn.dat | ISBN主索引 | ISBN->books.dat中的偏移位置  |
| index_name.dat | 书名倒排索引 | 书名->ISBN列表             |
| index_author.dat | 作者倒排索引 | 作者 → ISBN 列表           |
| index_keyword.dat | 关键字倒排索引 | 关键字 → ISBN 列表          |
| select.dat | 用户当前选中图书 | userID → ISBN |
| finance.dat | 进货与销售流水 | 交易记录 |
| log.dat | 日志信息 | 系统日志 |

## 类、结构体设计

### 1.Types.hpp

````
// 用户账号
struct UserRecord {
    char username[32]; 
    char password[32];
    int privilege;
};

// 登录栈单元
struct AccountSession {
    UserRecord user;
};


// 图书信息
struct BookRecord {
    char ISBN[20];
    char title[60];
    char author[60];
    char keyword_list[60];   // 关键字用 | 连接
    int quantity;
    double price;
};

// 某用户当前选中的书籍
struct SelectedBook {
    bool hasSelect;           // 是否已选书
    char ISBN[32];
};



// 倒排索引项：key -> ISBN
struct IndexEntry {
    char key[64];
    char ISBN[20];
};

// ISBN 主索引：ISBN -> file offset
struct ISBNIndex {
    char ISBN[20];
    long long offset;         // books.dat 偏移
};



struct FinanceRecord {
    double delta;             // +收入 / -支出
};



struct LogRecord {
    char message[128];
};
````

### CmdParser

````
class CmdParser {
public:
    ParsedCommand parseLine(const std::string &line);

private:
    std::vector<std::string> tokenize(const std::string &line);
    CommandType determineType(const std::vector<std::string> &tokens);
    bool validate(const std::vector<std::string> &tokens, CommandType type);

};
````

### AccountManager

````
class AccountManager {
public:
    AccountManager(Persistence &db);

    bool registerUser(const std::string &id, const std::string &pwd);
    bool login(const std::string &id, const std::string &pwd);
    bool loginDirect(const std::string &id);        // su
    void logout();
    bool passwd(const std::string &id, 
                const std::string &oldpwd, 
                const std::string &newpwd);
    bool useradd(const std::string &id, int privilege, const std::string &pwd);
    bool deleteUser(const std::string &id);

    int currentPrivilege() const;
    std::string currentUser() const;

private:
    Persistence &db;
    std::vector<AccountSession> stack;  // 登录栈
};
````

### BookManager

````
class BookManager {
public:
    BookManager(Persistence &db);

    std::vector<BookRecord> show(const ShowFilter &filter);
    bool select(const std::string &ISBN);
    bool modify(const ModifyArgs &args);
    bool import(int quantity, double cost);
    bool buy(const std::string &ISBN, int quantity);

private:
    Persistence &db;
    SelectedBook selected;
};
````

### Logger
````
class Transaction {
public:
    Transaction(Persistence &db);

    void add(double delta);    // 正数收入，负数支出
    void showFinance(int count) const;

private:
    Persistence &db;
};
````

### Transaction
````
class Transaction {
public:
    Transaction(Persistence &db);

    void add(double delta);    // 正数收入，负数支出
    void showFinance(int count) const;

private:
    Persistence &db;
};
````

### Persistence
````
class Persistence {
public:
    // 初始化，打开文件
    Persistence(const std::string &path);

    // user
    bool loadUser(const std::string &name, UserRecord &out);
    bool writeUser(const UserRecord &u);
    bool deleteUser(const std::string &name);
    std::vector<UserRecord> listUsers();

    // book
    bool readBookByOffset(long long offset, BookRecord &out);
    bool writeBook(long long offset, const BookRecord &book);
    long long appendBook(const BookRecord &book);

    // 索引
    std::vector<std::string> searchISBNIndex(const std::string &key);
    std::vector<std::string> searchInvertedIndex(const std::string &key, IndexType type);
    void insertIndex(const IndexEntry &entry, IndexType type);
    void removeIndex(const IndexEntry &entry, IndexType type);

    // finance
    void appendFinance(double delta);
    std::vector<FinanceRecord> getFinance();

    // log
    void appendLog(const std::string &msg);
    std::vector<LogRecord> getLogs();

private:
    std::fstream users;
    std::fstream books;
    std::fstream idxISBN;
    std::fstream idxName;
    std::fstream idxAuthor;
    std::fstream idxKeyword;
    std::fstream finance;
    std::fstream log;
};
````

### Utils

````
class Utils {
public:
    static std::string trim(const std::string &s);
    static bool isValidISBN(const std::string &s);
    static bool isValidKeywordChar(char c);
    static std::vector<std::string> splitKeywords(const std::string &s);

    static std::string formatPrice(double x);
};
````

## 其他补充说明